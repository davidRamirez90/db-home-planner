<section class="admin-page">
  <header class="admin-hero">
    <p class="eyebrow">Admin-Konfiguration</p>
    <h2>Stationssuche & gespeicherte Liste</h2>
    <p class="subtitle">
      Deutsche-Bahn-Stationen suchen und für die Abfahrtstafel speichern.
    </p>
  </header>

  <section class="card">
    <form class="station-form" [formGroup]="stationForm" (ngSubmit)="searchStations()">
      <label class="field">
        <span class="label">Stationsname oder Code</span>
        <input
          id="station-query"
          type="text"
          formControlName="stationQuery"
          autocomplete="off"
          placeholder="z. B. Berlin Hbf"
          aria-describedby="station-help"
        />
      </label>
      <p id="station-help" class="help">
        Mindestens 2 Zeichen eingeben (Name, EVA oder DS100-Code).
      </p>
      <div class="form-actions">
        <button
          type="submit"
          class="refresh-button"
          [disabled]="stationQuery.invalid || requestStatus() === 'loading'"
        >
          Stationen suchen
        </button>
        <span class="status" [attr.data-status]="requestStatus()">
          {{ displayRequestStatus(requestStatus()) }}
        </span>
      </div>
    </form>

    @if (requestStatus() === 'loading') {
      <p class="loading">Stationen werden gesucht…</p>
    }
    @if (errorMessage()) {
      <p class="error">{{ errorMessage() }}</p>
    }
    @if (requestStatus() === 'success') {
      @if (hasResults()) {
        <ul class="results">
          @for (station of stations(); track station.evaId) {
            <li class="result">
              <div class="result-header">
                <div class="result-title">{{ station.name }}</div>
                @if (trackedEvaIds().has(station.evaId)) {
                  <span class="saved-label" aria-label="Station gespeichert">Gespeichert</span>
                } @else {
                  <button
                    type="button"
                    class="save-button"
                    [disabled]="isSaving(station.evaId)"
                    (click)="saveStation(station)"
                  >
                    {{ isSaving(station.evaId) ? 'Speichern…' : 'Station speichern' }}
                  </button>
                }
              </div>
              <div class="result-meta">
                <span>EVA {{ station.evaId }}</span>
                @if (station.ds100) {
                  <span>DS100 {{ station.ds100 }}</span>
                }
              </div>
            </li>
          }
        </ul>
      } @else {
        <p class="empty">Keine Stationen für „{{ lastQuery() }}“ gefunden.</p>
      }
    }
  </section>

  <section class="card">
    <header class="section-header">
      <h3>Verfolgte Stationen</h3>
      <span class="status" [attr.data-status]="trackedRequestStatus()">
        {{ displayRequestStatus(trackedRequestStatus()) }}
      </span>
    </header>
    @if (trackedErrorMessage()) {
      <p class="error">{{ trackedErrorMessage() }}</p>
    }
    @if (saveErrorMessage()) {
      <p class="error">{{ saveErrorMessage() }}</p>
    }
    @if (trackedRequestStatus() === 'loading') {
      <p class="loading">Verfolgte Stationen werden geladen…</p>
    }
    @if (trackedRequestStatus() === 'success') {
      @if (hasTrackedStations()) {
        <ul class="results">
          @for (station of trackedStations(); track station.evaId) {
            <li class="result">
              <div class="result-title">{{ station.name }}</div>
              <div class="result-meta">
                <span>EVA {{ station.evaId }}</span>
                @if (station.ds100) {
                  <span>DS100 {{ station.ds100 }}</span>
                }
              </div>
            </li>
          }
        </ul>
      } @else {
        <p class="empty">Noch keine verfolgten Stationen. Speichere eine Station aus den Suchergebnissen.</p>
      }
    }
  </section>

  <section class="card">
    <header class="section-header">
      <h3>Routen & Wegzeiten</h3>
      <span class="status" [attr.data-status]="trackedRoutesRequestStatus()">
        {{ displayRequestStatus(trackedRoutesRequestStatus()) }}
      </span>
    </header>
    @if (!hasTrackedStations()) {
      <p class="empty">Bitte zuerst eine Station verfolgen, um verfügbare Routen zu finden.</p>
    } @else {
      <label class="field">
        <span class="label">Verfolgte Station</span>
        <select
          id="tracked-station"
          class="select"
          [value]="selectedStationEvaId()"
          (change)="selectStation($event)"
        >
          @for (station of trackedStations(); track station.evaId) {
            <option [value]="station.evaId">
              {{ station.name }} ({{ station.evaId }})
            </option>
          }
        </select>
      </label>

      <div class="route-actions">
        <button
          type="button"
          class="refresh-button"
          [disabled]="!selectedStation() || routeRequestStatus() === 'loading'"
          (click)="discoverRoutes()"
        >
          Routen suchen
        </button>
        <span class="status" [attr.data-status]="routeRequestStatus()">
          {{ displayRequestStatus(routeRequestStatus()) }}
        </span>
      </div>

      @if (routeRequestStatus() === 'loading') {
        <p class="loading">Routen für {{ selectedStation()?.name }} werden geladen…</p>
      }
      @if (routeErrorMessage()) {
        <p class="error">{{ routeErrorMessage() }}</p>
      }
      @if (routeRequestStatus() === 'success') {
        @if (hasDiscoveredRoutes()) {
          <ul class="results">
            @for (route of discoveredRoutes(); track route.line + route.direction) {
              <li class="result">
                <div class="result-header">
                  <div>
                    <div class="result-title">{{ route.line }}</div>
                    <div class="result-meta">
                      <span>{{ route.direction }}</span>
                    </div>
                  </div>
                  @if (trackedRouteKeys().has((route.line + '::' + route.direction).toLowerCase())) {
                    <span class="saved-label" aria-label="Route verfolgt">Verfolgt</span>
                  } @else {
                    <button
                      type="button"
                      class="save-button"
                      [disabled]="isTrackingRoute(route)"
                      (click)="trackRoute(route)"
                    >
                      {{ isTrackingRoute(route) ? 'Speichern…' : 'Route verfolgen' }}
                    </button>
                  }
                </div>
              </li>
            }
          </ul>
        } @else {
          <p class="empty">Noch keine Routen für {{ selectedStation()?.name }} gefunden.</p>
        }
      }

      <div class="section-divider"></div>

      <header class="section-header">
        <h4>Verfolgte Routen & Wegzeiten</h4>
      </header>
      @if (trackedRoutesErrorMessage()) {
        <p class="error">{{ trackedRoutesErrorMessage() }}</p>
      }
      @if (trackedRoutesRequestStatus() === 'loading') {
        <p class="loading">Verfolgte Routen werden geladen…</p>
      }
      @if (trackedRoutesRequestStatus() === 'success') {
        @if (hasTrackedRoutes()) {
          <ul class="results">
            @for (route of trackedRoutes(); track route.id) {
              <li class="result">
                <div class="result-header">
                  <div>
                    <div class="result-title">{{ route.line }}</div>
                    <div class="result-meta">
                      <span>{{ route.direction }}</span>
                    </div>
                  </div>
                </div>
                <div class="travel-times">
                  <div class="travel-times-header">Wegzeiten</div>
                  @if (travelTimeStatus(route.id) === 'loading') {
                    <p class="loading">Wegzeiten werden geladen…</p>
                  }
                  @if (travelTimeError(route.id)) {
                    <p class="error">{{ travelTimeError(route.id) }}</p>
                  }
                  @if (travelTimeStatus(route.id) === 'success') {
                    @if (travelTimes(route.id).length > 0) {
                      <ul class="travel-time-list">
                        @for (time of travelTimes(route.id); track time.id) {
                          <li>
                            <strong>{{ time.label }}</strong>
                            <span>{{ time.minutes }} Min</span>
                          </li>
                        }
                      </ul>
                    } @else {
                      <p class="empty">Noch keine Wegzeiten konfiguriert.</p>
                    }
                  }
                  <div class="travel-time-form">
                    <label class="field">
                      <span class="label">Bezeichnung</span>
                      <input
                        #labelInput
                        type="text"
                        [value]="travelTimeDraft(route.id).label"
                        placeholder="z. B. Schneller Gang"
                        (input)="updateTravelTimeLabel(route.id, labelInput.value)"
                      />
                    </label>
                    <label class="field">
                      <span class="label">Minuten</span>
                      <input
                        #minutesInput
                        type="number"
                        min="1"
                        [value]="travelTimeDraft(route.id).minutes"
                        placeholder="10"
                        (input)="updateTravelTimeMinutes(route.id, minutesInput.value)"
                      />
                    </label>
                    <button
                      type="button"
                      class="save-button"
                      [disabled]="savingTravelTimeRouteIds().includes(route.id)"
                      (click)="saveTravelTime(route)"
                    >
                      {{ savingTravelTimeRouteIds().includes(route.id) ? 'Speichern…' : 'Wegzeit speichern' }}
                    </button>
                  </div>
                </div>
              </li>
            }
          </ul>
        } @else {
          <p class="empty">Noch keine verfolgten Routen für {{ selectedStation()?.name }}.</p>
        }
      }
    }
  </section>
</section>

<section class="admin-page">
  <header class="admin-hero">
    <p class="eyebrow">Admin configuration</p>
    <h2>Station search & saved list</h2>
    <p class="subtitle">
      Search Deutsche Bahn stations and save them for the departures board.
    </p>
  </header>

  <section class="card">
    <form class="station-form" [formGroup]="stationForm" (ngSubmit)="searchStations()">
      <label class="field">
        <span class="label">Station name or code</span>
        <input
          id="station-query"
          type="text"
          formControlName="stationQuery"
          autocomplete="off"
          placeholder="e.g., Berlin Hbf"
          aria-describedby="station-help"
        />
      </label>
      <p id="station-help" class="help">
        Enter at least 2 characters (name, EVA, or DS100 code).
      </p>
      <div class="form-actions">
        <button
          type="submit"
          class="refresh-button"
          [disabled]="stationQuery.invalid || requestStatus() === 'loading'"
        >
          Search stations
        </button>
        <span class="status" [attr.data-status]="requestStatus()">
          {{ requestStatus() }}
        </span>
      </div>
    </form>

    @if (requestStatus() === 'loading') {
      <p class="loading">Searching stations…</p>
    }
    @if (errorMessage()) {
      <p class="error">{{ errorMessage() }}</p>
    }
    @if (requestStatus() === 'success') {
      @if (hasResults()) {
        <ul class="results">
          @for (station of stations(); track station.evaId) {
            <li class="result">
              <div class="result-header">
                <div class="result-title">{{ station.name }}</div>
                @if (trackedEvaIds().has(station.evaId)) {
                  <span class="saved-label" aria-label="Station saved">Saved</span>
                } @else {
                  <button
                    type="button"
                    class="save-button"
                    [disabled]="isSaving(station.evaId)"
                    (click)="saveStation(station)"
                  >
                    {{ isSaving(station.evaId) ? 'Saving…' : 'Save station' }}
                  </button>
                }
              </div>
              <div class="result-meta">
                <span>EVA {{ station.evaId }}</span>
                @if (station.ds100) {
                  <span>DS100 {{ station.ds100 }}</span>
                }
              </div>
            </li>
          }
        </ul>
      } @else {
        <p class="empty">No stations found for "{{ lastQuery() }}".</p>
      }
    }
  </section>

  <section class="card">
    <header class="section-header">
      <h3>Tracked stations</h3>
      <span class="status" [attr.data-status]="trackedRequestStatus()">
        {{ trackedRequestStatus() }}
      </span>
    </header>
    @if (trackedErrorMessage()) {
      <p class="error">{{ trackedErrorMessage() }}</p>
    }
    @if (saveErrorMessage()) {
      <p class="error">{{ saveErrorMessage() }}</p>
    }
    @if (trackedRequestStatus() === 'loading') {
      <p class="loading">Loading tracked stations…</p>
    }
    @if (trackedRequestStatus() === 'success') {
      @if (hasTrackedStations()) {
        <ul class="results">
          @for (station of trackedStations(); track station.evaId) {
            <li class="result">
              <div class="result-title">{{ station.name }}</div>
              <div class="result-meta">
                <span>EVA {{ station.evaId }}</span>
                @if (station.ds100) {
                  <span>DS100 {{ station.ds100 }}</span>
                }
              </div>
            </li>
          }
        </ul>
      } @else {
        <p class="empty">No tracked stations yet. Save a station from the search results.</p>
      }
    }
  </section>

  <section class="card">
    <header class="section-header">
      <h3>Routes & travel times</h3>
      <span class="status" [attr.data-status]="trackedRoutesRequestStatus()">
        {{ trackedRoutesRequestStatus() }}
      </span>
    </header>
    @if (!hasTrackedStations()) {
      <p class="empty">Track a station first to discover available routes.</p>
    } @else {
      <label class="field">
        <span class="label">Tracked station</span>
        <select
          id="tracked-station"
          class="select"
          [value]="selectedStationEvaId()"
          (change)="selectStation($event)"
        >
          @for (station of trackedStations(); track station.evaId) {
            <option [value]="station.evaId">
              {{ station.name }} ({{ station.evaId }})
            </option>
          }
        </select>
      </label>

      <div class="route-actions">
        <button
          type="button"
          class="refresh-button"
          [disabled]="!selectedStation() || routeRequestStatus() === 'loading'"
          (click)="discoverRoutes()"
        >
          Discover routes
        </button>
        <span class="status" [attr.data-status]="routeRequestStatus()">
          {{ routeRequestStatus() }}
        </span>
      </div>

      @if (routeRequestStatus() === 'loading') {
        <p class="loading">Fetching routes for {{ selectedStation()?.name }}…</p>
      }
      @if (routeErrorMessage()) {
        <p class="error">{{ routeErrorMessage() }}</p>
      }
      @if (routeRequestStatus() === 'success') {
        @if (hasDiscoveredRoutes()) {
          <ul class="results">
            @for (route of discoveredRoutes(); track route.line + route.origin + route.destination) {
              <li class="result">
                <div class="result-header">
                  <div>
                    <div class="result-title">{{ route.line }}</div>
                    <div class="result-meta">
                      <span>{{ route.origin }} -> {{ route.destination }}</span>
                    </div>
                  </div>
                  @if (trackedRouteKeys().has((route.line + '::' + route.origin + '::' + route.destination).toLowerCase())) {
                    <span class="saved-label" aria-label="Route tracked">Tracked</span>
                  } @else {
                    <button
                      type="button"
                      class="save-button"
                      [disabled]="isTrackingRoute(route)"
                      (click)="trackRoute(route)"
                    >
                      {{ isTrackingRoute(route) ? 'Saving…' : 'Track route' }}
                    </button>
                  }
                </div>
              </li>
            }
          </ul>
        } @else {
          <p class="empty">No routes found for {{ selectedStation()?.name }} yet.</p>
        }
      }

      <div class="section-divider"></div>

      <header class="section-header">
        <h4>Tracked routes & travel times</h4>
      </header>
      @if (trackedRoutesErrorMessage()) {
        <p class="error">{{ trackedRoutesErrorMessage() }}</p>
      }
      @if (trackedRoutesRequestStatus() === 'loading') {
        <p class="loading">Loading tracked routes…</p>
      }
      @if (trackedRoutesRequestStatus() === 'success') {
        @if (hasTrackedRoutes()) {
          <ul class="results">
            @for (route of trackedRoutes(); track route.id) {
              <li class="result">
                <div class="result-header">
                  <div>
                    <div class="result-title">{{ route.line }}</div>
                    <div class="result-meta">
                      <span>{{ route.origin }} -> {{ route.destination }}</span>
                    </div>
                  </div>
                </div>
                <div class="travel-times">
                  <div class="travel-times-header">Travel times</div>
                  @if (travelTimeStatus(route.id) === 'loading') {
                    <p class="loading">Loading travel times…</p>
                  }
                  @if (travelTimeError(route.id)) {
                    <p class="error">{{ travelTimeError(route.id) }}</p>
                  }
                  @if (travelTimeStatus(route.id) === 'success') {
                    @if (travelTimes(route.id).length > 0) {
                      <ul class="travel-time-list">
                        @for (time of travelTimes(route.id); track time.id) {
                          <li>
                            <strong>{{ time.label }}</strong>
                            <span>{{ time.minutes }} min</span>
                          </li>
                        }
                      </ul>
                    } @else {
                      <p class="empty">No travel times configured yet.</p>
                    }
                  }
                  <div class="travel-time-form">
                    <label class="field">
                      <span class="label">Label</span>
                      <input
                        #labelInput
                        type="text"
                        [value]="travelTimeDraft(route.id).label"
                        placeholder="e.g., Fast walk"
                        (input)="updateTravelTimeLabel(route.id, labelInput.value)"
                      />
                    </label>
                    <label class="field">
                      <span class="label">Minutes</span>
                      <input
                        #minutesInput
                        type="number"
                        min="1"
                        [value]="travelTimeDraft(route.id).minutes"
                        placeholder="10"
                        (input)="updateTravelTimeMinutes(route.id, minutesInput.value)"
                      />
                    </label>
                    <button
                      type="button"
                      class="save-button"
                      [disabled]="savingTravelTimeRouteIds().includes(route.id)"
                      (click)="saveTravelTime(route)"
                    >
                      {{ savingTravelTimeRouteIds().includes(route.id) ? 'Saving…' : 'Save travel time' }}
                    </button>
                  </div>
                </div>
              </li>
            }
          </ul>
        } @else {
          <p class="empty">No tracked routes yet for {{ selectedStation()?.name }}.</p>
        }
      }
    }
  </section>
</section>
